/*==========================================================================;
 *
 *  File:    JSTe3s.min.js
 *  Desc:    Simple tetris engine 
 *  Created: Oct-2013
 *
 *  Author:  Miha Grcar
 *
 ***************************************************************************/

(function(){
Type.registerNamespace('JSTe3s');JSTe3s.Key=function(){};JSTe3s.Key.prototype = {none:0,left:1,right:2,rotate:3,drop:4,restart:5,pause:6,showNext:7,speedUp:8,other:9}
JSTe3s.Key.registerEnum('JSTe3s.Key',false);JSTe3s.State=function(){};JSTe3s.State.prototype = {play:0,pause:1,gameOver:2}
JSTe3s.State.registerEnum('JSTe3s.State',false);JSTe3s.Playfield=function(){}
JSTe3s.Playfield.arrayClear=function(array){for(var $0=0;$0<20;$0++){array[$0]=[0,0,0,0,0,0,0,0,0,0];}}
JSTe3s.Playfield.arrayClear2=function(array,y){array[y]=[0,0,0,0,0,0,0,0,0,0];}
JSTe3s.Playfield.arrayCopy=function(src,dst){for(var $0=0;$0<20;$0++){dst[$0]=src[$0].clone();}}
JSTe3s.Playfield.arrayCopy4=function(src,srcY,dst,dstY){dst[dstY]=src[srcY].clone();}
JSTe3s.Playfield.clear=function(){JSTe3s.Playfield.arrayClear(JSTe3s.Playfield.mGrid);JSTe3s.Playfield.arrayClear(JSTe3s.Playfield.mGridBkgr);}
JSTe3s.Playfield.updateBkgr=function(){JSTe3s.Playfield.arrayCopy(JSTe3s.Playfield.mGrid,JSTe3s.Playfield.mGridBkgr);}
JSTe3s.Playfield.updateBlock=function(){JSTe3s.Playfield.arrayCopy(JSTe3s.Playfield.mGridBkgr,JSTe3s.Playfield.mGrid);var $0=JSTe3s.Block.mBlock.mShape[JSTe3s.Block.mBlock.mRot];for(var $1=0,$2=JSTe3s.Block.mBlock.mPosY;$1<4&&$2<20;$1++,$2++){for(var $3=0,$4=JSTe3s.Block.mBlock.mPosX;$3<4&&$4<10;$3++,$4++){if($0[$1].charAt($3)==='1'){JSTe3s.Playfield.mGrid[$2][$4]=JSTe3s.Block.mBlock.mType;}}}}
JSTe3s.Playfield.collapse=function(){var $0=new Array(20);for(var $4=0;$4<20;$4++){$0[$4]=[0,0,0,0,0,0,0,0,0,0];}var $1=19;var $2=false;var $3=0;for(var $5=19;$5>=0;$5--){var $6=true;for(var $7=0;$7<10;$7++){if(!JSTe3s.Playfield.mGrid[$5][$7]){$6=false;break;}}if($6){JSTe3s.Playfield.arrayClear2(JSTe3s.Playfield.mGrid,$5);renderer_RenderRow($5);sound_Play('LINE');$2=true;$3++;}else{JSTe3s.Playfield.arrayCopy4(JSTe3s.Playfield.mGrid,$5,$0,$1);$1--;}}if($2){JSTe3s.Playfield.arrayCopy($0,JSTe3s.Playfield.mGrid);renderer_RenderPlayfield();}return $3;}
JSTe3s.Block=function(shape,type){this.mPosY=-1;this.mShape=shape;this.mType=type;}
JSTe3s.Block.newBlock=function(){if(JSTe3s.Block.mNextBlock==null){JSTe3s.Block.mNextBlock=JSTe3s.Block.mBlocks[Math.round(Math.random()*6)].clone();}JSTe3s.Block.mBlock=JSTe3s.Block.mNextBlock;JSTe3s.Program.mStats[JSTe3s.Block.mBlock.mType-1]++;if(JSTe3s.Program.mStats[JSTe3s.Block.mBlock.mType-1]>1428){JSTe3s.Program.mStats[JSTe3s.Block.mBlock.mType-1]=1428;}renderer_RenderStats();JSTe3s.Block.mNextBlock=JSTe3s.Block.mBlocks[Math.round(Math.random()*6)].clone();var $0=JSTe3s.Block.check(JSTe3s.Block.mBlock.mPosX,JSTe3s.Block.mBlock.mPosY,JSTe3s.Block.mBlock.mRot);JSTe3s.Playfield.updateBlock();renderer_RenderBlock();if(JSTe3s.Program.mShowNext){renderer_RenderNextBlock();}return $0;}
JSTe3s.Block.check=function(posX,posY,rot){var $0=JSTe3s.Block.mBlock.mShape[rot];for(var $1=0,$2=posY;$1<4;$1++,$2++){for(var $3=0,$4=posX;$3<4;$3++,$4++){if($0[$1].charAt($3)==='1'&&($4<0||$2<0||$4>=10||$2>=20||!!JSTe3s.Playfield.mGridBkgr[$2][$4])){return false;}}}return true;}
JSTe3s.Block.update=function(){JSTe3s.Playfield.updateBlock();renderer_RenderBlock();}
JSTe3s.Block.moveLeft=function(){if(JSTe3s.Block.check(JSTe3s.Block.mBlock.mPosX-1,JSTe3s.Block.mBlock.mPosY,JSTe3s.Block.mBlock.mRot)){JSTe3s.Block.mBlock.mPosX--;JSTe3s.Block.update();return true;}return false;}
JSTe3s.Block.moveRight=function(){if(JSTe3s.Block.check(JSTe3s.Block.mBlock.mPosX+1,JSTe3s.Block.mBlock.mPosY,JSTe3s.Block.mBlock.mRot)){JSTe3s.Block.mBlock.mPosX++;JSTe3s.Block.update();return true;}return false;}
JSTe3s.Block.moveDown=function(){if(JSTe3s.Block.check(JSTe3s.Block.mBlock.mPosX,JSTe3s.Block.mBlock.mPosY+1,JSTe3s.Block.mBlock.mRot)){JSTe3s.Block.mBlock.mPosY++;JSTe3s.Block.update();return true;}return false;}
JSTe3s.Block.rotate=function(){var $0=(JSTe3s.Block.mBlock.mRot+1)%4;if(JSTe3s.Block.check(JSTe3s.Block.mBlock.mPosX,JSTe3s.Block.mBlock.mPosY,$0)){JSTe3s.Block.mBlock.mRot=$0;JSTe3s.Block.update();return true;}return false;}
JSTe3s.Block.drop=function(){var $0=JSTe3s.Block.check(JSTe3s.Block.mBlock.mPosX,JSTe3s.Block.mBlock.mPosY+1,JSTe3s.Block.mBlock.mRot);while(JSTe3s.Block.check(JSTe3s.Block.mBlock.mPosX,JSTe3s.Block.mBlock.mPosY+1,JSTe3s.Block.mBlock.mRot)){JSTe3s.Block.mBlock.mPosY++;}if($0){JSTe3s.Playfield.updateBlock();renderer_RenderPlayfield();}return $0;}
JSTe3s.Block.prototype={mShape:null,mType:0,mRot:0,mPosX:3,clone:function(){var $0=new JSTe3s.Block(this.mShape,this.mType);$0.mPosX=this.mPosX;$0.mPosY=this.mPosY;$0.mRot=this.mRot;return $0;}}
JSTe3s.Program=function(){}
JSTe3s.Program.resetTimer=function(){JSTe3s.Program.mTimer=Date.get_now();}
JSTe3s.Program.timer=function(){return Date.get_now()-JSTe3s.Program.mTimer>=(10-JSTe3s.Program.mLevel)*50;}
JSTe3s.Program.resetStats=function(){JSTe3s.Program.mScore=0;JSTe3s.Program.mLevel=0;JSTe3s.Program.mFullLines=0;JSTe3s.Program.mStats=[0,0,0,0,0,0,0];}
JSTe3s.Program.play=function(){if(!JSTe3s.Program.mState){switch(keyboard_GetKey()){case 1:JSTe3s.Block.moveLeft();break;case 2:JSTe3s.Block.moveRight();break;case 3:JSTe3s.Block.rotate();break;case 4:JSTe3s.Block.drop();break;case 6:JSTe3s.Program.mTimeLeft=Date.get_now()-JSTe3s.Program.mTimer;renderer_RenderPause();JSTe3s.Program.mState=1;return;case 7:JSTe3s.Program.mShowNext=!JSTe3s.Program.mShowNext;if(JSTe3s.Program.mShowNext){renderer_RenderNextBlock();}else{renderer_ClearNextBlock();}break;case 8:JSTe3s.Program.mLevel++;if(JSTe3s.Program.mLevel>9){JSTe3s.Program.mLevel=9;}renderer_RenderLevel();break;}if(JSTe3s.Program.timer()){if(!JSTe3s.Block.moveDown()){var $0=(21+3*(JSTe3s.Program.mLevel+1))-JSTe3s.Program.mSteps;var $1=Math.floor(JSTe3s.Program.mScore/1000);JSTe3s.Program.mScore+=$0;if(JSTe3s.Program.mScore>99999){JSTe3s.Program.mScore=99999;}if(Math.floor(JSTe3s.Program.mScore/1000)>$1){sound_Play('1000');}renderer_RenderScore();JSTe3s.Program.mSteps=0;JSTe3s.Program.mFullLines+=JSTe3s.Playfield.collapse();if(JSTe3s.Program.mFullLines>99){JSTe3s.Program.mFullLines=99;}renderer_RenderFullLines();JSTe3s.Program.mLevel=Math.max(JSTe3s.Program.mLevel,Math.floor((JSTe3s.Program.mFullLines-1)/10));renderer_RenderLevel();JSTe3s.Playfield.updateBkgr();if(!JSTe3s.Block.newBlock()){sound_Play('GAMEOVER');renderer_RenderGameOver();JSTe3s.Program.mState=2;return;}}else{JSTe3s.Program.mSteps++;}JSTe3s.Program.resetTimer();}}else if(JSTe3s.Program.mState===1){var $2=keyboard_GetKey();if($2===5||$2===6){renderer_ClearPause();JSTe3s.Program.mTimer=new Date(Date.get_now().getTime()-JSTe3s.Program.mTimeLeft);JSTe3s.Program.mState=0;}}else if(JSTe3s.Program.mState===2){var $3=keyboard_GetKey();if(!!$3){if($3===5){JSTe3s.Program.resetStats();renderer_Init();JSTe3s.Playfield.clear();renderer_RenderPlayfield();JSTe3s.Block.newBlock();JSTe3s.Program.resetTimer();JSTe3s.Program.mState=0;}}}}
JSTe3s.Program.init=function(){renderer_Init();renderer_RenderPlayfield();JSTe3s.Block.newBlock();JSTe3s.Program.resetTimer();}
JSTe3s.Playfield.registerClass('JSTe3s.Playfield');JSTe3s.Block.registerClass('JSTe3s.Block');JSTe3s.Program.registerClass('JSTe3s.Program');JSTe3s.Playfield.mGrid=new Array(20);JSTe3s.Playfield.mGridBkgr=new Array(20);(function(){for(var $0=0;$0<20;$0++){JSTe3s.Playfield.mGrid[$0]=[0,0,0,0,0,0,0,0,0,0];JSTe3s.Playfield.mGridBkgr[$0]=[0,0,0,0,0,0,0,0,0,0];}})();
JSTe3s.Block.mBlocks=[new JSTe3s.Block(['0000,0111,0100,0000'.split(','),'0010,0010,0011,0000'.split(','),'0001,0111,0000,0000'.split(','),'0110,0010,0010,0000'.split(',')],1),new JSTe3s.Block(['0000,1111,0000,0000'.split(','),'0010,0010,0010,0010'.split(','),'0000,1111,0000,0000'.split(','),'0010,0010,0010,0010'.split(',')],2),new JSTe3s.Block(['0000,0111,0010,0000'.split(','),'0010,0011,0010,0000'.split(','),'0010,0111,0000,0000'.split(','),'0010,0110,0010,0000'.split(',')],3),new JSTe3s.Block(['0000,0011,0110,0000'.split(','),'0010,0011,0001,0000'.split(','),'0000,0011,0110,0000'.split(','),'0010,0011,0001,0000'.split(',')],4),new JSTe3s.Block(['0000,0110,0011,0000'.split(','),'0001,0011,0010,0000'.split(','),'0000,0110,0011,0000'.split(','),'0001,0011,0010,0000'.split(',')],5),new JSTe3s.Block(['0000,0110,0110,0000'.split(','),'0000,0110,0110,0000'.split(','),'0000,0110,0110,0000'.split(','),'0000,0110,0110,0000'.split(',')],6),new JSTe3s.Block(['0000,0111,0001,0000'.split(','),'0011,0010,0010,0000'.split(','),'0100,0111,0000,0000'.split(','),'0010,0010,0110,0000'.split(',')],7)];JSTe3s.Block.mBlock=null;JSTe3s.Block.mNextBlock=null;JSTe3s.Program.mLevel=0;JSTe3s.Program.mSteps=0;JSTe3s.Program.mScore=0;JSTe3s.Program.mFullLines=0;JSTe3s.Program.mShowNext=false;JSTe3s.Program.mStats=[0,0,0,0,0,0,0];JSTe3s.Program.mTimer=null;JSTe3s.Program.mState=0;JSTe3s.Program.mTimeLeft=0;})();// This script was generated using Script# v0.7.4.0
